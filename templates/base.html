<!DOCTYPE html>
{% if current_path is starting_with("/kr/") %}
  {% set page_lang = "ko" %}
  {% set langprefix = "/kr" %}
{% else %}
  {% set page_lang = "en" %}
  {% set langprefix = "" %}
{% endif %}

<html lang="{{ page_lang }}">
  <head>
    <meta charset="utf-8" />
    <title>{% if page %}{{ page.title }} · {% endif %}{{ config.title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="{{ get_url(path='favicon.ico') }}" sizes="any">
    <link rel="icon" href="{{ get_url(path='favicon.svg') }}" type="image/svg+xml">

    <style>
      html:not(.wf-active):not(.wf-inactive) body { visibility: hidden; }
      html.wf-loading body { visibility: hidden; }
      html.wf-active body,
      html.wf-inactive body { visibility: visible; }
      html.wf-active body { animation: fontFadeIn .18s ease-out; }
      @keyframes fontFadeIn { from { opacity: 0 } to { opacity: 1 } }
    </style>

    <link rel="preconnect" href="https://use.typekit.net" crossorigin>
    <link rel="preconnect" href="https://p.typekit.net" crossorigin>

    <script>
      (function(d) {
        var config = { kitId: 'efe0obd', scriptTimeout: 3000, async: true },
            h = d.documentElement,
            t = setTimeout(function() {
              h.className = h.className.replace(/\bwf-loading\b/g,"") + " wf-inactive";
            }, config.scriptTimeout),
            tk = d.createElement("script"),
            f = false,
            s = d.getElementsByTagName("script")[0],
            a;
        h.className += " wf-loading";
        tk.src = "https://use.typekit.net/" + config.kitId + ".js";
        tk.async = true;
        tk.onload = tk.onreadystatechange = function() {
          a = this.readyState;
          if (f || (a && a !== "complete" && a !== "loaded")) return;
          f = true; clearTimeout(t);
          try { Typekit.load(config); } catch (e) {}
        };
        s.parentNode.insertBefore(tk, s);
      })(document);
    </script>

    <link rel="stylesheet" href="{{ get_url(path='css/main.css') }}">
  </head>

  <body>
    <div class="shell">
      <aside class="site-nav">
        <div class="nav-bar" role="navigation" aria-label="mobile top bar">
          <button class="nav-toggle" id="menu-toggle" aria-expanded="false" aria-controls="nav-menu">menu</button>
          {% if page_lang == "ko" %}
          <a href="{{ get_url(path=current_path | replace(from='/kr', to='')) }}" class="lang-toggle">en</a>
          {% else %}
          <a href="{{ get_url(path='kr' ~ current_path) }}" class="lang-toggle">kr</a>
          {% endif %}
        </div>

        <nav id="nav-menu" aria-label="primary">
          <a href="{{ get_url(path=langprefix ~ '/') }}">all archive</a><br>
          <a href="{{ get_url(path=langprefix ~ '/works/') }}">works</a><br>
          <a href="{{ get_url(path=langprefix ~ '/about/') }}">about</a><br>
          <a href="{{ get_url(path=langprefix ~ '/contact/') }}">contact</a><br>
          <span class="nav-item nav-item--disabled" aria-disabled="true" title="Coming soon">shop</span>
        </nav>

        <div class="lang-toggle--desktop"> 
          {% if page_lang == "ko" %} 
          <a href="{{ get_url(path=current_path | replace(from='/kr', to='')) }}">en</a> 
          {% else %} 
          <a href="{{ get_url(path='kr' ~ current_path) }}">kr</a> 
          {% endif %} 
        </div> 
      </aside>

      <main class="site-main">
        {% block content %}{% endblock content %}
      </main>
    </div>

    <footer class="site-footer" role="contentinfo" aria-label="site footer">
      <p class="site-footer__text">
        j-h, jaydashaitch, online archive of jae hyeon lee. ©2025 jaehyeon lee
      </p>
      <p class="site-footer__text--mobile">
        j-h, ©2025 jaehyeon lee
      </p>
    </footer>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const HANGUL_RE = /([\u1100-\u11FF\u3130-\u318F\uAC00-\uD7A3]+)/g;
        const SKIP_SELECTOR = 'pre, code, kbd, samp, script, style';
        const walker = document.createTreeWalker(
          document.body,
          NodeFilter.SHOW_TEXT,
          {
            acceptNode(node) {
              if (!node.nodeValue || !HANGUL_RE.test(node.nodeValue)) return NodeFilter.FILTER_REJECT;
              let p = node.parentNode;
              while (p && p !== document.body) {
                if (p.matches && p.matches(SKIP_SELECTOR)) return NodeFilter.FILTER_REJECT;
                p = p.parentNode;
              }
              return NodeFilter.FILTER_ACCEPT;
            }
          }
        );
        const texts = [];
        let n;
        while (n = walker.nextNode()) texts.push(n);
        for (const text of texts) {
          const span = document.createElement('span');
          span.innerHTML = text.nodeValue.replace(HANGUL_RE, '<span class="han">$1</span>');
          text.parentNode.replaceChild(span, text);
        }
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("menu-toggle");
        const menu = document.getElementById("nav-menu");
        if (!btn || !menu) return;

        function closeMenu() {
          menu.classList.remove("open");
          btn.setAttribute("aria-expanded", "false");
        }

        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const isOpen = menu.classList.toggle("open");
          btn.setAttribute("aria-expanded", String(isOpen));
        });

        document.addEventListener("click", (e) => {
          if (!menu.contains(e.target) && !btn.contains(e.target)) closeMenu();
        });

        window.addEventListener("resize", () => {
          if (window.innerWidth > 600) closeMenu();
        });
      });
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        if (window.__FN_WIRED__) return;
        window.__FN_WIRED__ = true;

        const SCROLL_MS = 300;
        const HL_IN_MS = 200;
        const HL_OUT_MS = 700;
        const HL_HOLD_MS = 800;

        const isScrollable = (el) => {
          if (!el) return false;
          const s = getComputedStyle(el);
          const oy = s.overflowY;
          return (oy === "auto" || oy === "scroll") && el.scrollHeight > el.clientHeight;
        };

        const getScrollContainer = (el) => {
          let node = el.parentElement;
          while (node && node !== document.body && node !== document.documentElement) {
            if (isScrollable(node)) return node;
            node = node.parentElement;
          }
          return document.scrollingElement || document.documentElement || document.body;
        };

        const easeInOutSticky = (t) => {
          const t2 = t * t, t3 = t2 * t, t4 = t2 * t2, t5 = t4 * t;
          const base = 6 * t5 - 15 * t4 + 10 * t3;
          const OUT_BIAS = 1.12;
          return 1 - Math.pow(1 - base, OUT_BIAS);
        };

        const scrollToTarget = (container, target, ms = SCROLL_MS, offsetY = 0) =>
          new Promise((resolve) => {
            const containerIsDoc =
              container === document.scrollingElement ||
              container === document.documentElement ||
              container === document.body;

            const containerRect = containerIsDoc ? { top: 0 } : container.getBoundingClientRect();
            const targetRect = target.getBoundingClientRect();

            const start = containerIsDoc
              ? window.pageYOffset || document.documentElement.scrollTop
              : container.scrollTop;

            const targetY = start + (targetRect.top - containerRect.top) + offsetY;

            const startTime = performance.now();
            const step = (now) => {
              const t = Math.min(1, (now - startTime) / ms);
              const eased = easeInOutSticky(t);
              const y = start + (targetY - start) * eased;

              if (containerIsDoc) window.scrollTo(0, y);
              else container.scrollTop = y;

              if (t < 1) requestAnimationFrame(step);
              else {
                if (containerIsDoc) window.scrollTo(0, targetY);
                else container.scrollTop = targetY;
                resolve();
              }
            };

            requestAnimationFrame(step);
          });

        const highlight = (host, hold = HL_HOLD_MS) => {
          if (!host) return;
          host.classList.add('fn-hl');
          requestAnimationFrame(() => {
            host.style.setProperty('--fn-hl-in', `${HL_IN_MS}ms`);
            host.style.setProperty('--fn-hl-out', `${HL_OUT_MS}ms`);
            host.classList.add('is-on');
            setTimeout(() => {
              host.classList.add('is-fading');
              host.classList.remove('is-on');
              setTimeout(() => host.classList.remove('fn-hl', 'is-fading'), HL_OUT_MS + 30);
            }, hold);
          });
        };

        const allIds = new Set([...document.querySelectorAll('[id]')].map(el => el.id));
        const bodyLinks = [...document.querySelectorAll('.page-content a[href^="#"]')]
          .filter(a => !a.closest('.footnote-definition') && !a.closest('.footnotes'));

        const footnoteIds = new Set(
          bodyLinks
            .map(a => (a.getAttribute('href') || '').slice(1))
            .filter(id => id && allIds.has(id))
        );

        const getFootnoteBlock = (id) => {
          const el = document.getElementById(id);
          return el ? (el.closest('.footnote-definition') || el.closest('.footnotes li[id^="fn"]') || el) : null;
        };

        const backMap = new Map();
        bodyLinks.forEach(a => {
          const id = (a.getAttribute('href') || '').slice(1);
          if (!footnoteIds.has(id)) return;
          const sup = a.closest('sup[id^="fnref"]') || a.closest('sup');
          const target = sup || a;
          if (!target.id) {
            let base = `fnref-auto-${id}`, i = 1, uid = base;
            while (document.getElementById(uid)) uid = `${base}-${i++}`;
            target.id = uid;
          }
          backMap.set(id, target.id);
        });

        document.addEventListener('click', async (e) => {
          const ref = e.target.closest('.page-content a[href^="#"]');
          if (!ref) return;
          const id = ref.getAttribute('href').slice(1);
          if (!footnoteIds.has(id)) return;
          e.preventDefault();
          const fnBlock = getFootnoteBlock(id);
          if (!fnBlock) return;
          const container = getScrollContainer(fnBlock);
          await scrollToTarget(container, fnBlock);
          history.pushState(null, '', `#${id}`);
          highlight(fnBlock);
        });

        document.addEventListener('click', async (e) => {
          let node = e.target.closest('[id]');
          while (node) {
            if (footnoteIds.has(node.id)) {
              const backId = backMap.get(node.id);
              if (!backId) return;
              e.preventDefault();
              const backEl = document.getElementById(backId);
              if (!backEl) return;
              const container = getScrollContainer(backEl);
              await scrollToTarget(container, backEl);
              history.pushState(null, '', `#${backId}`);
              highlight(backEl);
              return;
            }
            node = node.parentElement;
          }
        });

        const flashFromHash = async () => {
          const id = location.hash.slice(1);
          if (!id) return;
          const el = document.getElementById(id);
          if (!el) return;
          const target = el.closest('.footnote-definition') || el.closest('.footnotes li[id^="fn"]') || el;
          const container = getScrollContainer(target);
          await scrollToTarget(container, target);
          highlight(target);
        };

        window.addEventListener('hashchange', () => setTimeout(flashFromHash, 30));
        if (location.hash) setTimeout(flashFromHash, 60);
      });
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.page-content ol > li').forEach(li => {
          if (li.querySelector(':scope > .li-body')) return;
          const body = document.createElement('span');
          body.className = 'li-body';
          while (li.firstChild) body.appendChild(li.firstChild);
          li.appendChild(body);
        });
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const currentHost = window.location.hostname;
        const links = document.querySelectorAll('a[href^="http"]');
        links.forEach(link => {
          const url = new URL(link.href);
          if (url.hostname !== currentHost) {
            link.setAttribute("target", "_blank");
            link.setAttribute("rel", "noopener noreferrer");
          }
        });
      });
    </script>
  </body>
</html>
